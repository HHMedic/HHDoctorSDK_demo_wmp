<view class='main-container' style='padding-top:{{sysInfo.statusBarHeight}}px' bindtap='_hideBtn'>
  <!-- 顶部按纽 -->
  <view class='btn-panel' style='height:{{msgPanelTop}}px;'>

    <view class='topbtn-panel' style='background-color:{{uiStyle.navBarBg}};height:{{wxMbb.top+38}}px' wx:if='{{"custom"==navStyle}}'>
      <block wx:if='{{_request.personalIconVisible}}'>
        <view class='topbtn personal {{personalIconLight}}' catchtap='_viewPers' style='top:{{wxMbb.top+4}}px;'></view>
      </block>
      <view class='topbtn-title' style='color:{{uiStyle.navBarFg}};top:{{wxMbb.top+4}}px;'>{{uiStyle.pageTitle}}</view>
    </view>

    <block wx:if='{{_request.callPage}}'>
      <view class='mainbtn-panel'>
        <view class='btn-main' catchtap='_showHideBtn' style='{{customStyle.mainBtn?customStyle.mainBtn:""}}'>
          <text>呼叫医生</text>
        </view>
      </view>
    </block>
  </view>

  <view wx:if='{{disConnected}}' class='disconnect-info' style='top:{{wxMbb.top+95}}px;' animation='{{disconnAnimation}}'>网络中断，重新连接中...</view>

  <!-- 呼叫按钮 -->
  <block wx:if='{{_request.callPage}}'>
    <view class='callbtn-panel' style='top:{{callBtnTop}}px;' animation="{{animationData}}">
      <view class='call-doctor' catchtap='_callDoctor' data-dept='600002' style='{{customStyle.popBtn}}'>
        <image class='btn-call-img' src='https://imgs.hh-medic.com/icon/wmp/online-adult.png'></image>
        <text class='btn-call-text' style='{{customStyle.popBtnText}}'>成人</text>
      </view>
      <view class='call-btn-sept'></view>
      <view class='call-doctor' catchtap='_callDoctor' data-dept='600000' style='{{customStyle.popBtn}}'>
        <image class='btn-call-img' src='https://imgs.hh-medic.com/icon/wmp/online-child.png'></image>
        <text class='btn-call-text' style='{{customStyle.popBtnText}}'>儿科</text>
      </view>
    </view>
  </block>

  <!-- 中部消息列表 -->
  <scroll-view class='msg-panel-scroll' style='top:{{msgPanelTop}}px;height:{{msgPanelHeight}}px;' scroll-y scroll-into-view='{{lastMsgId}}' bindscrolltoupper='_loadMoreHisMsg'>
    <block wx:for='{{msgList}}' wx:for-item='msg' wx:key='{{time}}'>
      <view class='msg-row timestamp'>
        <text class='msg-time'>{{msg.timeText}}</text>
      </view>

      <block wx:if='{{"text"==msg.type}}'>
        <template is='msgText' data='{{...msg,asst:_request.style.asst}}'></template>
      </block>

      <block wx:if='{{"image"==msg.type}}'>
        <template is='msgImg' data='{{...msg,asst:_request.style.asst}}'></template>
      </block>

      <block wx:if='{{"audio"==msg.type}}'>
        <template is='msgAudio' data='{{...msg,asst:_request.style.asst}}'></template>
      </block>

      <block wx:if='{{"card"==msg.type && "summaryByFam"==msg.bodyContent.command}}'>
        <template is='msgCardSummary' data='{{...msg,ehrPage:_request.ehrPage,title:_request.style.card.summaryTitle}}'></template>
      </block>

      <block wx:if='{{"card"==msg.type && "buyDrugInformation"==msg.bodyContent.command}}'>
        <template is='msgCardMed' data='{{...msg,title:_request.style.card.medTitle,btnStyle:customStyle.mainBtn}}'></template>
      </block>

      <block wx:if='{{"card"==msg.type && "videoAdv"==msg.bodyContent.command}}'>
        <template is='msgCardVideoAdv' data='{{...msg,title:_request.style.card.videoAdvTitle}}'></template>
      </block>

      <block wx:if='{{"card"==msg.type && "buyService"==msg.bodyContent.command}}'>
        <template is='msgCardBuy' data='{{...msg,title:_request.style.card.buyServiceTitle}}'></template>
      </block>
    </block>
  </scroll-view>

  <!-- 底部工具栏 -->
  <view class='input-panel' style='height:{{bottomHeight}}px;bottom:{{safeAreaHight}}px' animation='{{utilsAnimation}}'>
    <view class='input-tools'>
      <!-- 左侧切换输入模式按纽 -->
      <view class='input-btn-box' catchtap='_changeInputType'>
        <view class='input-btn {{inputTypeClass}}'></view>
      </view>
      <!-- 中部输入区域 -->
      <view class='input-text'>
        <block wx:if='{{inputTextVisible}}'>
          <input class='textarea' type='text' confirm-type='send' cursor-spacing='50' bindinput='_inputText' bindconfirm='_sendTextMsg' value='{{inputText}}' confirm-hold='true' adjust-position='false'></input>
        </block>
        <block wx:if='{{!inputTextVisible}}'>
          <view class='input-record' catchtouchstart='_startRecord' catchtouchend='_stopRecord' catchtouchmove='_cancelRecord'>{{recordBtnTip}}</view>
        </block>
      </view>
      <!-- 右侧加号按纽 -->
      <view class='input-btn-box' catchtap='_showHideUtils'>
        <view class='input-btn plus'></view>
      </view>
    </view>

    <view class='safe-area' style='height:{{safeAreaHight}}px'></view>

    <!-- 点击右侧加号弹出层 -->
    <view class='util-tools'>
      <view class='util-tool' catchtap='_selectImage' data-type='camera'>
        <view class='util-icon camera'></view>
        <view class='util-text'>相机</view>
      </view>
      <view class='util-tool' catchtap='_selectImage' data-type='album'>
        <view class='util-icon album'></view>
        <view class='util-text'>相册</view>
      </view>
    </view>

    <!-- 扩展工具栏 -->
    <view class='extend-panel' wx:if='{{extendBtns.length>0}}'>
      <scroll-view class='extend-view' scroll-x>
        <block wx:for='{{extendBtns}}' wx:for-item='extendBtn' wx:key=''>
          <view class='extend-btn' catchtap='{{extendBtn.tap?extendBtn.tap:"_tapExtendBtn"}}' data-btn='{{extendBtn}}'>{{extendBtn.name}}</view>
        </block>
      </scroll-view>
    </view>

  </view>
</view>

<!-- 录音提示遮罩层 -->
<view class='record-mask {{recordMaskVisible}}'>
  <view class='record-msg-box'>
    <view class='record-msg-icon {{recordCancel?"cancel":""}}'></view>
    <view class='record-msg-text {{recordCancel?"cancel":""}}'></view>
  </view>
</view>



<!-- 各类型消息模版 -->
<!-- 1.文本消息模版 -->
<template name='msgText'>
  <view class='msg-row {{"c"==from?"user":""}}' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{("d"==from&&asst.photo)?asst.photo:head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body {{"c"==from?"user":""}}'>
      <block wx:if='{{"c"!=from}}'>
        <view class='msg-name'>{{asst.name?asst.name:name}}</view>
      </block>
      <view class='msg-content-main {{"c"==from?"user":""}}'>
        <view class='msg {{"c"==from?"user":""}} text'>{{text}}</view>
      </view>
    </view>
  </view>
</template>

<!-- 2.图片消息模版 -->
<template name='msgImg'>
  <view class='msg-row {{"c"==from?"user":""}}' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{("d"==from&&asst.photo)?asst.photo:head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body {{"c"==from?"user":""}}'>
      <block wx:if='{{"c"!=from}}'>
        <view class='msg-name'>{{asst.name?asst.name:name}}</view>
      </block>
      <view class='msg-content-main {{"c"==from?"user":""}}' catchtap='_previewImg' data-url='{{url}}'>
        <image class='msg image' mode='widthFix' src='{{thumbnail}}'></image>
      </view>
    </view>
  </view>
</template>

<!-- 3.音频消息模版 -->
<template name='msgAudio'>
  <view class='msg-row {{"c"==from?"user":""}}' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{("d"==from&&asst.photo)?asst.photo:head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body {{"c"==from?"user":""}}'>
      <block wx:if='{{"c"!=from}}'>
        <view class='msg-name'>{{asst.name?asst.name:name}}</view>
      </block>
      <view class='msg-content-main {{"c"==from?"user":""}}'>
        <view class='msg {{"c"==from?"user":""}} audio' catchtap='_playAudio' data-url='{{url}}' data-id='msg{{time}}' data-dur='{{dur}}'>
          <view class='sound-icon {{"c"==from?"user":""}} arc1 {{"c"==from?"user":""}}'></view>
          <view class='sound-icon {{"c"==from?"user":""}} arc2 {{"c"==from?"user":""}}'></view>
          <view class='sound-icon {{"c"==from?"user":""}} arc3 {{"c"==from?"user":""}}'></view>
        </view>
        <view class='sound-length {{"c"==from?"user":""}}'>{{durText}}"</view>
      </view>
    </view>
  </view>
</template>

<!-- 4.视频咨询总结卡片消息模版 -->
<template name='msgCardSummary'>
  <view class='msg-row' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body card'>
      <view class='msg-name'>{{name}}</view>
      <view class='msg-content-main'>
        <view class='msg card'>
          <view class='msg-card-head'>{{title?title:'家庭医生视频咨询总结'}}</view>
          <view class='msg-card-body summary'>
            <view class='summary-row'>
              <view class='summary name'>就诊人</view>
              <view class='summary value'>{{bodyContent.name}}</view>
            </view>
            <view class='summary-row'>
              <view class='summary name'>咨询时间</view>
              <view class='summary value'>{{timeText}}</view>
            </view>
          </view>
          <!-- <block wx:if='{{ehrPage}}'> -->
          <view class='msg-card-foot'>
            <view class='show-more' catchtap='_viewSummary' data-mrid='{{bodyContent.medicRecordId}}' data-patient='{{patient}}'>
              <view class='show-more-text'></view>
              <view class='show-more-arraw'></view>
            </view>
          </view>
          <!-- </block> -->
        </view>
      </view>
    </view>
  </view>
</template>

<!-- <template name='msgCardMed'>
  <view class='msg-row' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body card'>
      <view class='msg-name'>{{name}}</view>
      <view class='msg-content-main'>
        <view class='msg card'>
          <view class='msg-card-head'>{{title?title:'用药说明'}}</view>
          <view class='msg-card-body medicine'>
            <view class='summary-row'>
              <view class='summary medicine name'>用药人</view>
              <view class='summary medicine value'>{{bodyContent.name}}</view>
            </view>
            <block wx:for='{{bodyContent.medicationList}}' wx:for-item='medicine' wx:key='{{name}}'>
              <view class='medicine-row'>
                <view class='medicine'>{{medicine.name}}
                  <text class='medicine count'>{{medicine.count}}{{medicine.unit}}</text>
                </view>
                <view class='medicine-remark'>{{medicine.remark}}</view>
              </view>
            </block>
          </view>
        </view>
      </view>
    </view>
  </view>
</template> -->

<!-- 5.用药指导卡片模版 -->
<template name='msgCardMed'>
  <view class='msg-row' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body card'>
      <view class='msg-name'>{{name}}</view>
      <view class='msg-content-main'>
        <view class='msg card'>
          <view class='msg-card-head'>{{title?title:bodyContent.name+'用药说明'}}</view>
          <view class='msg-card-body medicine'>
            <block wx:for='{{bodyContent.medicationList}}' wx:for-item='medicine' wx:key='{{name}}'>
              <view class='medicine-row'>
                <view class='medicine'>
                  <view class='medicine-name'>{{medicine.name}}</view>
                  <view class='medicine-count'>{{medicine.count}}</view>
                </view>
                <view class='medicine-remark'>{{medicine.remark}}</view>
              </view>
            </block>
          </view>
          <view class='msg-card-foot'>
            <view class='show-more'>
              <view class='show-more-btn {{bodyContent.trans?"":"disabled"}}' style='{{bodyContent.trans?btnStyle:""}};' catchtap='_buyMedicine' data-drugid='{{bodyContent.drugOrderId}}' data-trans='{{bodyContent.trans}}'>{{bodyContent.trans?bodyContent.buttonName:'本单不支持配送'}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<!-- 6.视频卡片消息模版 -->
<template name='msgCardVideoAdv'>
  <view class='msg-row' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body card'>
      <view class='msg-name'>{{name}}</view>
      <view class='msg-content-main'>
        <view class='msg card'>
          <view class='msg-card-head'>{{title?title:bodyContent.title}}</view>
          <view class='msg-card-body videoAdv'>
            <video src='{{bodyContent.content}}' poster='{{bodyContent.thumb}}'></video>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>

<!-- 7.购买套餐卡片模版 -->
<template name='msgCardBuy'>
  <view class='msg-row' id='msg{{time}}'>
    <view class='msg-img'>
      <image class='img-head' src='{{head}}?x-oss-process=image/resize,m_fixed,h_70,w_70'></image>
    </view>
    <view class='msg-body card'>
      <view class='msg-name'>{{name}}</view>
      <view class='msg-content-main'>
        <view class='msg card'>
          <view class='msg-card-head'>{{title?title:'和缓会员'}}</view>
          <view class='msg-card-body summary'>
            <block wx:for='{{bodyContent.services}}' wx:for-item='sevice' wx:key=''>
              <view class='summary-row'>{{sevice}}</view>
            </block>
          </view>
          <view class='msg-card-foot'>
            <view class='show-more' catchtap='_buyProduct' data-price='{{bodyContent.price}}' data-pid='{{bodyContent.productId}}'>
              <view class='show-more-text custom'>{{bodyContent.price}}</view>
              <view class='show-more-arraw'></view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>