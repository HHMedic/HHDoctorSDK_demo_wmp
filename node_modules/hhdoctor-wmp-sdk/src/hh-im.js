// components/hh-im.js
const hhBehaviors = require('./hhBehaviors.js');
var that;
var waitInterval;

Component({
  behaviors: [hhBehaviors],
  /**
   * 组件的属性列表
   */
  properties: {
    callPage: {
      type: String,
      value: ''
    },

    viewTarget: {
      type: String
    },

    viewModule: {
      type: String,
      value: 'memberList'
    },

    appointedDoctorId: {
      type: String,
      value: ''
    },
    appointedOrderId: {
      type: String,
      value: ''
    },

    addMember: {
      type: String,
      value: 'true'
    },

    patient: {
      type: String,
      value: ''
    },

    medicRecordId: {
      type: String,
      value: ''
    }
  },

  lifetimes: {
    attached() {
      that = this;
    },
    ready() {
      this.setData({
        host: this.getHost()
      })

      waitInterval = setInterval(function() {
        that._waitforParams();
      }, 100);
    },
    detached() {
      if (waitInterval) {
        clearInterval(waitInterval);
      }
    }
  },

  /**
   * 组件的初始数据
   */
  data: {
    url: '',
    host: {}
  },

  /**
   * 组件的方法列表
   */
  methods: {
    propertyChanged(newVal, oldVal, changedPath) {
      //this._viewIm();
    },

    onWebLoad() {
      console.log('onWebLoad');
    },

    _waitforParams() {
      if (!this.data.userUuid || !this.data.userToken ||
        !this.data.sdkProductId || !this.data.openId) {
        return;
      }
      if (waitInterval) {
        clearInterval(waitInterval);
      }

      switch (that.data.viewTarget.toLowerCase()) {
        case 'im':
          that._viewIm();
          break;
        case 'ehr':
          that._viewEhr();
          break;
        default:
          break;
      }
    },

    _viewIm() {
      if (!this.data.userUuid || !this.data.userToken ||
        !this.data.sdkProductId || !this.data.openId) {
        return;
      }
      var vParam = 'module=im' +
        '&appId=' + this.data.sdkProductId +
        //'&appKey=' + this.data.appKey +
        '&uuid=' + this.data.userUuid +
        '&token=' + this.data.userToken +
        '&openId=' + this.data.openId +
        '&version=3';

      if (this.data.callPage) {
        vParam += ('&callPage=' + encodeURIComponent(this.data.callPage));
      }

      if (this.data.appointedOrderId) {
        vParam += ('&orderId=' + this.data.appointedOrderId);
      }
      if (this.data.appointedDoctorId) {
        vParam += ('&doctorId=' + this.data.appointedDoctorId);
      }
      var s = that.data.host.wmpHost + 'view/?' + vParam;
      this.setData({
        url: s
      })
    },

    _viewEhr() {
      if (!this.data.userUuid || !this.data.userToken ||
        !this.data.sdkProductId ||
        !this.data.openId) {
        return;
      }
      var vParam = 'module=' + this.data.viewModule +
        '&appId=' + this.data.sdkProductId +
        '&uuid=' + this.data.userUuid +
        '&token=' + this.data.userToken +
        '&openId=' + this.data.openId;
      if (this.data.appointedOrderId) {
        vParam += ('&orderId=' + this.data.appointedOrderId);
      }
      if (this.data.appointedDoctorId) {
        vParam += ('&doctorId=' + this.data.appointedDoctorId);
      }
      if ('false' == this.data.addMember) {
        vParam += '&hideAddBtn=true';
      }

      if (this.data.patient) {
        var p = Number(this.data.patient);
        if (isNaN(p)) {
          vParam += '&patientUserToken=';
        } else {
          vParam += '&patient=';
        }
        vParam += this.data.patient;
      }
      if (this.data.medicRecordId) {
        vParam += '&mrid=' + this.data.medicRecordId;
      }

      var s = that.data.host.ehrHost + 'view/?' + vParam;
      this.setData({
        url: s
      })
    }
  }
})